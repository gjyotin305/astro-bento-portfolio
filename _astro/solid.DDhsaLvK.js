const o={context:void 0,registry:void 0,effects:void 0,done:!1,getContextId(){return H(this.context.count)},getNextContextId(){return H(this.context.count++)}};function H(e){const t=String(e),s=t.length-1;return o.context.id+(s?String.fromCharCode(96+s):"")+t}function g(e){o.context=e}function q(){return{...o.context,id:o.getNextContextId(),count:0}}const ee=(e,t)=>e===t,m={equals:ee};let M=B;const p=1,E=2,V={owned:null,cleanups:null,context:null,owner:null};var l=null;let L=null,te=null,i=null,c=null,a=null,N=0;function ne(e,t){const s=i,n=l,r=e.length===0,u=t===void 0?n:t,f=r?V:{owned:null,cleanups:null,context:u?u.context:null,owner:u},$=r?e:()=>e(()=>h(()=>U(f)));l=f,i=null;try{return C($,!0)}finally{i=s,l=n}}function R(e,t){t=t?Object.assign({},m,t):m;const s={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),z(s,r));return[W.bind(s),n]}function se(e,t,s){const n=T(e,t,!1,p);S(n)}function re(e,t,s){M=he;const n=T(e,t,!1,p),r=A&&Q(A);r&&(n.suspense=r),n.user=!0,a?a.push(n):S(n)}function w(e,t,s){s=s?Object.assign({},m,s):m;const n=T(e,t,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,S(n),W.bind(n)}function h(e){if(i===null)return e();const t=i;i=null;try{return e()}finally{i=t}}function be(e){re(()=>h(e))}function ue(e){return l===null||(l.cleanups===null?l.cleanups=[e]:l.cleanups.push(e)),e}function oe(){return l}function le(e){a.push.apply(a,e),e.length=0}function G(e,t){const s=Symbol("context");return{id:s,Provider:de(s),defaultValue:e}}function Q(e){let t;return l&&l.context&&(t=l.context[e.id])!==void 0?t:e.defaultValue}function ie(e){const t=w(e),s=w(()=>P(t()));return s.toArray=()=>{const n=s();return Array.isArray(n)?n:n!=null?[n]:[]},s}let A;function ce(){return A||(A=G())}function W(){if(this.sources&&this.state)if(this.state===p)S(this);else{const e=c;c=null,C(()=>F(this),!1),c=e}if(i){const e=this.observers?this.observers.length:0;i.sources?(i.sources.push(this),i.sourceSlots.push(e)):(i.sources=[this],i.sourceSlots=[e]),this.observers?(this.observers.push(i),this.observerSlots.push(i.sources.length-1)):(this.observers=[i],this.observerSlots=[i.sources.length-1])}return this.value}function z(e,t,s){let n=e.value;return(!e.comparator||!e.comparator(n,t))&&(e.value=t,e.observers&&e.observers.length&&C(()=>{for(let r=0;r<e.observers.length;r+=1){const u=e.observers[r],f=L&&L.running;f&&L.disposed.has(u),(f?!u.tState:!u.state)&&(u.pure?c.push(u):a.push(u),u.observers&&J(u)),f||(u.state=p)}if(c.length>1e6)throw c=[],new Error},!1)),t}function S(e){if(!e.fn)return;U(e);const t=N;fe(e,e.value,t)}function fe(e,t,s){let n;const r=l,u=i;i=l=e;try{n=e.fn(t)}catch(f){return e.pure&&(e.state=p,e.owned&&e.owned.forEach(U),e.owned=null),e.updatedAt=s+1,K(f)}finally{i=u,l=r}(!e.updatedAt||e.updatedAt<=s)&&(e.updatedAt!=null&&"observers"in e?z(e,n):e.value=n,e.updatedAt=s)}function T(e,t,s,n=p,r){const u={fn:e,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:l,context:l?l.context:null,pure:s};return l===null||l!==V&&(l.owned?l.owned.push(u):l.owned=[u]),u}function k(e){if(e.state===0)return;if(e.state===E)return F(e);if(e.suspense&&h(e.suspense.inFallback))return e.suspense.effects.push(e);const t=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<N);)e.state&&t.push(e);for(let s=t.length-1;s>=0;s--)if(e=t[s],e.state===p)S(e);else if(e.state===E){const n=c;c=null,C(()=>F(e,t[0]),!1),c=n}}function C(e,t){if(c)return e();let s=!1;t||(c=[]),a?s=!0:a=[],N++;try{const n=e();return ae(s),n}catch(n){s||(a=null),c=null,K(n)}}function ae(e){if(c&&(B(c),c=null),e)return;const t=a;a=null,t.length&&C(()=>M(t),!1)}function B(e){for(let t=0;t<e.length;t++)k(e[t])}function he(e){let t,s=0;for(t=0;t<e.length;t++){const n=e[t];n.user?e[s++]=n:k(n)}if(o.context){if(o.count){o.effects||(o.effects=[]),o.effects.push(...e.slice(0,s));return}g()}for(o.effects&&(o.done||!o.count)&&(e=[...o.effects,...e],s+=o.effects.length,delete o.effects),t=0;t<s;t++)k(e[t])}function F(e,t){e.state=0;for(let s=0;s<e.sources.length;s+=1){const n=e.sources[s];if(n.sources){const r=n.state;r===p?n!==t&&(!n.updatedAt||n.updatedAt<N)&&k(n):r===E&&F(n,t)}}}function J(e){for(let t=0;t<e.observers.length;t+=1){const s=e.observers[t];s.state||(s.state=E,s.pure?c.push(s):a.push(s),s.observers&&J(s))}}function U(e){let t;if(e.sources)for(;e.sources.length;){const s=e.sources.pop(),n=e.sourceSlots.pop(),r=s.observers;if(r&&r.length){const u=r.pop(),f=s.observerSlots.pop();n<r.length&&(u.sourceSlots[f]=n,r[n]=u,s.observerSlots[n]=f)}}if(e.owned){for(t=e.owned.length-1;t>=0;t--)U(e.owned[t]);e.owned=null}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null}e.state=0}function pe(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function K(e,t=l){throw pe(e)}function P(e){if(typeof e=="function"&&!e.length)return P(e());if(Array.isArray(e)){const t=[];for(let s=0;s<e.length;s++){const n=P(e[s]);Array.isArray(n)?t.push.apply(t,n):t.push(n)}return t}return e}function de(e,t){return function(n){let r;return se(()=>r=h(()=>(l.context={...l.context,[e]:n.value},ie(()=>n.children))),void 0),r}}let X=!1;function ve(){X=!0}function ge(e,t){if(X&&o.context){const s=o.context;g(q());const n=h(()=>e(t||{}));return g(s),n}return h(()=>e(t||{}))}const we=e=>`Stale read from <${e}>.`;function ye(e){const t=e.keyed,s=w(()=>e.when,void 0,{equals:(n,r)=>t?n===r:!n==!r});return w(()=>{const n=s();if(n){const r=e.children;return typeof r=="function"&&r.length>0?h(()=>r(t?n:()=>{if(!h(s))throw we("Show");return e.when})):r}return e.fallback},void 0,void 0)}const xe=G();function Se(e){let t=0,s,n,r,u,f;const[$,j]=R(!1),Y=ce(),b={increment:()=>{++t===1&&j(!0)},decrement:()=>{--t===0&&j(!1)},inFallback:$,effects:[],resolved:!1},Z=oe();if(o.context&&o.load){const v=o.getContextId();let x=o.load(v);if(x&&(typeof x!="object"||x.status!=="success"?r=x:o.gather(v)),r&&r!=="$$f"){const[I,y]=R(void 0,{equals:!1});u=I,r.then(()=>{if(o.done)return y();o.gather(v),g(n),y(),g()},O=>{f=O,y()})}}const D=Q(xe);D&&(s=D.register(b.inFallback));let d;return ue(()=>d&&d()),ge(Y.Provider,{value:b,get children(){return w(()=>{if(f)throw f;if(n=o.context,u)return u(),u=void 0;n&&r==="$$f"&&g();const v=w(()=>e.children);return w(x=>{const I=b.inFallback(),{showContent:y=!0,showFallback:O=!0}=s?s():{};if((!I||r&&r!=="$$f")&&y)return b.resolved=!0,d&&d(),d=n=r=void 0,le(b.effects),v();if(O)return d?x:ne(_=>(d=_,n&&(g({id:n.id+"F",count:0}),n=void 0),e.fallback),Z)})})}})}export{ye as S,ge as a,Se as b,R as c,se as d,ne as e,ve as f,ue as g,be as o,o as s,h as u};
